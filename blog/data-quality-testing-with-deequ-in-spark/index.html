<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>EgorDm's Blog ‚Ä¢ Data Quality Testing with Deequ in Spark</title><link href=static/img/avatar.jpg rel=icon type=image/png><link title="EgorDm's Blog" href=https://egordmitriev.dev/atom.xml rel=alternate type=application/atom+xml><link href=https://egordmitriev.dev/custom_subset.css rel=stylesheet><link href=https://egordmitriev.dev/main.css media=screen rel=stylesheet><meta name=description><meta content="index, nofollow" name=robots><meta content="EgorDm's Blog" property=og:title><meta content=article property=og:type><meta content=https://egordmitriev.dev/blog/data-quality-testing-with-deequ-in-spark/ property=og:url><meta property=og:description><meta content="EgorDm's Blog" property=og:site_name><meta content="default-src 'self';font-src 'self' data: egordm.github.io;img-src 'self' https://* data: egordm.github.io;script-src 'self' egordm.github.io;style-src 'self' egordm.github.io;frame-src player.vimeo.com https://www.youtube-nocookie.com egordm.github.io" http-equiv=Content-Security-Policy><script src=https://egordmitriev.dev/js/initialize_theme_min.js></script><script defer src=https://egordmitriev.dev/js/main_min.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://egordmitriev.dev>EgorDm's Blog</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://egordmitriev.dev>home</a><li><a class="nav-links no-hover-padding" href=https://egordmitriev.dev/blog>blog</a><li><a class="nav-links no-hover-padding" href=https://egordmitriev.dev/archive>archive</a><li><a class="nav-links no-hover-padding" href=https://egordmitriev.dev/tags>tags</a><li class=theme-switcher-wrapper><div class=theme-switcher></div></ul></div></nav></header><div class=content><main><article><div class=article-title>Data Quality Testing with Deequ in Spark</div><ul class=meta><li>20th Jun 2023 ‚Ä¢<li title="3524 words">¬†18 min read<li>¬†‚Ä¢¬†Tags:¬†<li><a href=https://egordmitriev.dev/tags/data-engineering/>data engineering</a>,¬†<li><a href=https://egordmitriev.dev/tags/spark/>spark</a></ul><section class=body><small> Originaly published as part of <a href=https://www.luminis.eu/blog/data-quality-testing-with-deequ-in-spark/ target=_blank>Luminis Data Blog</a>. </small><h2 id=introduction><a aria-label="Anchor link for: introduction" class=zola-anchor href=#introduction>üîó</a>Introduction</h2><p>In this blog, we will explore how to ensure data quality in a Spark Scala ETL (Extract, Transform, Load) job. To achieve this, we will leverage <a href=https://github.com/awslabs/deequ rel=noopener target=_blank>Deequ</a>, an open-source library, to define and enforce various data quality checks.<p>If you need a refresher on data quality and its importance in data processing pipelines, you can refer to our previous blog post, <a href=https://www.luminis.eu/blog/introduction-to-data-quality/ rel=noopener target=_blank>‚ÄúIntroduction to Data Quality‚Äù</a>. To recap, data quality is essential for accurate data analysis, decision-making, and achieving business objectives. It involves maintaining clean and standardized data that meets expectations. Ensuring data quality requires measuring and testing the data at different stages of the data pipeline. This may include unit testing, functional testing, and integration testing. A few testable properties of data are schema, freshness, quality, and volume which we will focus on in this blog.<p>To illustrate these concepts, we will use a mock dataset based on the Iowa Liquor Sales Dataset as a running example. The dataset as well as the complete code for this blog can be found in the following <a href=https://github.com/EgorDm/deequ-spark-example rel=noopener target=_blank>GitHub repository</a>.<p>The rest of the blog is structured as follows:<ul><li><strong>Technologies</strong><li><strong>Setup</strong><li><strong>The Dataset</strong><li><strong>Building Schema Checks</strong><li><strong>Profiling Your Data</strong><li><strong>Adding Data Quality Checks</strong><li><strong>Collecting Data Quality Metrics</strong><li><strong>Gracefully Handling Data Changes</strong><li><strong>Anomaly Detection</strong><li><strong>Conclusion</strong></ul><h2 id=technologies><a aria-label="Anchor link for: technologies" class=zola-anchor href=#technologies>üîó</a>Technologies</h2><p>Ensuring data quality in Spark can be achieved using various tools and libraries. One notable option is Deequ, an open-source library developed by AWS. It is a simple, but featureful tool that integrates well into AWS Glue or other Spark runtimes. By incorporating Deequ into our pipeline, we can perform schema checks, validate quality constraints, detect anomalies, collect quality metrics for monitoring, and utilize data profiling to gain insights into the properties of our data. Deequ effectively translates high-level rules and metrics into optimized Spark code, using the full potential of your Spark cluster.<p>Other popular choices for data quality testing are tools like <a href=https://greatexpectations.io/ rel=noopener target=_blank>Great Expectations</a> and <a href=https://www.soda.io/platform rel=noopener target=_blank>Soda Core</a>. These tools are rich in features, but also require additional configuration and setup, which may be explored in future blogs. For users already working within an AWS Glue ecosystem, exploring options that are tightly integrated with Glue, such as Deequ, can be more convenient and seamless.<p>For brevity, we will focus on adding data quality to bare-bones Spark ETL scripts. While the implementation is similar if you are using AWS Glue, we won't cover it in this blog. Instead, you can find an example glue script in the code repository.<h2 id=setup><a aria-label="Anchor link for: setup" class=zola-anchor href=#setup>üîó</a>Setup</h2><p>To begin, you need to have a working Scala development environment. If you don't, install Java, <a href=https://www.scala-lang.org/download/ rel=noopener target=_blank>Scala</a>, and <a href=https://www.scala-sbt.org/download.html rel=noopener target=_blank>sbt (Scala Build Tool)</a>. For Linux x86 the installation would look as follows:<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Install Java (on Debian)</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> apt install default-jre</span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Install Coursier (Scala Version Manager)</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">curl</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>fL</span> https://github.com/coursier/coursier/releases/latest/download/cs-x86_64-pc-linux.gz</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gzip</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> cs</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chmod</span></span><span class="z-meta z-function-call z-arguments z-shell"> +x cs</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./cs</span></span><span class="z-meta z-function-call z-arguments z-shell"> setup</span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Install Scala 2.12 and sbt</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cs</span></span><span class="z-meta z-function-call z-arguments z-shell"> install scala:2.12.15</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cs</span></span><span class="z-meta z-function-call z-arguments z-shell"> install scalac:2.12.15</span>
</span></code></pre><p>Next, download a compatible <a href=https://spark.apache.org/downloads.html rel=noopener target=_blank>Apache Spark</a> distribution (version 3.3.x is recommended) and add the <code>bin</code> folder to your system path. If you can run <code>spark-submit</code>, you are all set.<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Download Spark</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">curl</span></span><span class="z-meta z-function-call z-arguments z-shell"> https://dlcdn.apache.org/spark/spark-3.3.2/spark-3.3.2-bin-hadoop3.tgz<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>output</span> hadoop.tgz</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tar</span></span><span class="z-meta z-function-call z-arguments z-shell"> xvf hadoop.tgz</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mv</span></span><span class="z-meta z-function-call z-arguments z-shell"> spark-3.3.2-bin-hadoop3 /usr/local/spark</span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Add the following line to your .bashrc (adds Spark to PATH)</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PATH</span></span>:/usr/local/spark/bin<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span></span>
</span></code></pre><h3 id=sample-script><a aria-label="Anchor link for: sample-script" class=zola-anchor href=#sample-script>üîó</a>Sample Script</h3><p>If you haven't already, clone the <a href=https://github.com/EgorDm/deequ-spark-example rel=noopener target=_blank>example project</a> and open it in your editor of choice.<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">git clone git@github.com:EgorDm/deequ-spark-example.git
</span></code></pre><p>You will find an <a href=https://github.com/EgorDm/deequ-spark-example/blob/master/src/main/scala/EmptyExample.scala rel=noopener target=_blank>empty example Spark script</a> that reads a CSV file and writes it in parquet format to the output path. It takes the input path, output path and a path for metric storage as command line arguments.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">main</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">sysArgs</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Array</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	<span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Parse job arguments  </span>
	<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">args</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Map</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
		<span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>input_file_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span> -> sysArgs<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
		<span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>output_file_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span> -> sysArgs<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
		<span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span> -> sysArgs<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">2</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	  
	<span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Read the CSV input file  </span>
	<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">rawDf</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> spark<span class="z-punctuation z-accessor z-scala">.</span>read  
		<span class="z-punctuation z-accessor z-scala">.</span>option<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>header<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>true<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>csv<span class="z-punctuation z-section z-group z-begin z-scala">(</span>args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>input_file_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	  
	logger<span class="z-punctuation z-accessor z-scala">.</span>info<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Do some preprocessing<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	  
	<span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Write the result to S3 in Parquet format  </span>
	rawDf<span class="z-punctuation z-accessor z-scala">.</span>write  
		<span class="z-punctuation z-accessor z-scala">.</span>mode<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>overwrite<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>parquet<span class="z-punctuation z-section z-group z-begin z-scala">(</span>args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>output_file_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>Compile the script with the following command, which will output the jar as <code>target/scala-2.12/glue-deequ_2.12-0.1.0.jar</code>.<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">sbt compile && sbt package
</span></code></pre><p>Running this Spark job is straightforward:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">spark-submit \
	--class EmptyExample \  
	./target/scala-2.12/glue-deequ_2.12-0.1.0.jar \  
	"./data/iowa_liquor_sales_lite/year=2022/iowa_liquor_sales_01.csv" \  
	"./outputs/sales/iowa_liquor_sales_processed" \  
	"./outputs/dataquality/iowa_liquor_sales_processed"
</span></code></pre><h3 id=include-deequ-library><a aria-label="Anchor link for: include-deequ-library" class=zola-anchor href=#include-deequ-library>üîó</a>Include Deequ Library</h3><p>Since we will be using the Deequ library, it must be added as a dependency to our project. While the library is already included in the project's dependencies, it is deliberately not bundled into the compiled jar. Instead, you can use the following command to extract it to the <code>target/libs</code> folder, or you can download it yourself from the <a href=https://repo1.maven.org/maven2/com/amazon/deequ/deequ/ rel=noopener target=_blank>maven repository</a>.<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">sbt copyRuntimeDependencies
</span></code></pre><p>Pass the <code>--jars</code> option to the Spark job, so the library is loaded at runtime:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">spark-submit</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">	--</span>jars</span> ./target/libs/deequ-2.0.3-spark-3.3.jar \<span class="z-invalid z-illegal z-extraneous-spaces-after-line-continuation z-shell">  </span>
</span>	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">--class</span></span><span class="z-meta z-function-call z-arguments z-shell"> ExampleSpark \<span class="z-invalid z-illegal z-extraneous-spaces-after-line-continuation z-shell">  </span>
</span>	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./target/scala-2.12/glue-deequ_2.12-0.1.0.jar</span></span><span class="z-meta z-function-call z-arguments z-shell"> \<span class="z-invalid z-illegal z-extraneous-spaces-after-line-continuation z-shell">  </span>
</span>	<span class="z-variable z-other z-readwrite z-assignment z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>./data/iowa_liquor_sales_lite/year=2022/iowa_liquor_sales_01.csv<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> \<span class="z-invalid z-illegal z-extraneous-spaces-after-line-continuation z-shell">  </span>
	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>./outputs/sales/iowa_liquor_sales_processed<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> \<span class="z-invalid z-illegal z-extraneous-spaces-after-line-continuation z-shell">  </span>
</span>	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>./outputs/dataquality/iowa_liquor_sales_processed<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell">  </span>
</span></code></pre><p>After running the command, the output parquet files are stored in <code>outputs/sales/iowa_liquor_sales_processed</code> and can be inspected with Spark, Pandas, or data tools like <a href=https://duckdb.org/docs/guides/data_viewers/tad.html rel=noopener target=_blank>tad</a>.<h2 id=the-dataset><a aria-label="Anchor link for: the-dataset" class=zola-anchor href=#the-dataset>üîó</a>The Dataset</h2><p>Now that we have our example ETL script working, let's take a look at the dataset. The mock dataset is based on the <a href=https://data.iowa.gov/Sales-Distribution/Iowa-Liquor-Sales/m3tr-qhgy rel=noopener target=_blank>Iowa Liquor Sales dataset</a>, which is simplified and modified to contain various data issues representative of the real world.<p>The dataset is partitioned by year, where each partition introduces schema and/or distribution changes.<pre class=z-code><code><span class="z-text z-plain">data/iowa_liquor_sales_lite/
	year=2020/iowa_liquor_sales_*.csv
	year=2021/iowa_liquor_sales_*.csv
	year=2022/iowa_liquor_sales_*.csv
</span></code></pre><p>Assuming that we have already conducted exploratory data analysis, we will start building our data quality checks by using the 2022 partition and will consider at the end how the other partitions impact our solution.<figure class=image-captions-figure><img alt="Anomaly Detection on Row Count quality metric in Soda Cloud" height=186 src=https://egordmitriev.dev/processed_images/iowa_liquor_dataset_preview-e1686825218211.e910aa72ffde4ad6.png width=600><figcaption class=image-captions-caption><p>Preview of <a href=https://github.com/EgorDm/deequ-spark-example/blob/master/data/iowa_liquor_sales_lite/year%3D2022/iowa_liquor_sales_01.csv rel=noopener target=_blank>Iowa Liquor Sales dataset</a>.</p></figcaption></figure><h2 id=building-schema-checks><a aria-label="Anchor link for: building-schema-checks" class=zola-anchor href=#building-schema-checks>üîó</a>Building Schema Checks</h2><p>The first step is validating the schema of our dataset. A schema defines the structure and organization of the data, including the names and types of columns. By performing schema checks, we can ensure that our data conforms to the expected structure and identify any inconsistencies or missing columns.<p>To define the schema, we use Deequ's <code>RowLevelSchema</code> class. Here, each column and its properties are defined using methods like <code>withStringColumn</code>, <code>withIntColumn</code>, <code>withTimestampColumn</code>, or <code>withDecimalColumn</code>. For our dataset, the schema is as follows:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">schema</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">RowLevelSchema</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withStringColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Invoice/Item Number<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withStringColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Date<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withStringColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Store Name<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withStringColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Zip Code<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withStringColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Vendor Name<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withIntColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Item Number<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withIntColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Bottles Sold<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withDecimalColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Sale<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-separator z-scala">,</span> precision <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-numeric z-integer z-decimal z-scala">12</span><span class="z-punctuation z-separator z-scala">,</span> scale <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-numeric z-integer z-decimal z-scala">2</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>withDecimalColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Volume Sold (Liters)<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> isNullable <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">true</span><span class="z-punctuation z-separator z-scala">,</span> precision <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-numeric z-integer z-decimal z-scala">12</span><span class="z-punctuation z-separator z-scala">,</span> scale <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-numeric z-integer z-decimal z-scala">2</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre><p>After defining the schema, it can be validated against the data (<code>rawDf</code>) using the <code>RowLevelSchemaValidator.validate</code> method.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">schemaResult</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">RowLevelSchemaValidator</span><span class="z-punctuation z-accessor z-scala">.</span>validate<span class="z-punctuation z-section z-group z-begin z-scala">(</span>rawDf<span class="z-punctuation z-separator z-scala">,</span> schema<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-keyword z-control z-flow z-scala">if</span> <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>schemaResult<span class="z-punctuation z-accessor z-scala">.</span>numInvalidRows > <span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	logger<span class="z-punctuation z-accessor z-scala">.</span>error<span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
	<span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Schema validation failed with <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">schemaResult<span class="z-punctuation z-accessor z-scala">.</span>numInvalidRows</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span> invalid rows. Results: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">schemaResult</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	schemaResult<span class="z-punctuation z-accessor z-scala">.</span>invalidRows<span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">10</span><span class="z-punctuation z-separator z-scala">,</span> truncate <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	sys<span class="z-punctuation z-accessor z-scala">.</span>exit<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">validDf</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> schemaResult<span class="z-punctuation z-accessor z-scala">.</span>validRows
</span></code></pre><p>The result (<code>schemaResult</code>) contains two Data Frames, specifically the valid rows that conform to the schema and invalid rows that do not. In some cases, data quarantining can be applied by preserving invalid rows and moving forward. Here, we will break and display faulty data in the console instead.<h2 id=profiling-your-data><a aria-label="Anchor link for: profiling-your-data" class=zola-anchor href=#profiling-your-data>üîó</a>Profiling Your Data</h2><p>The next step is data profiling, which is an essential step for understanding the characteristics and properties of your dataset. It provides insights into the structure, content, and statistical properties of the data, enabling you to identify potential issues or anomalies, and make informed decisions about data cleansing or transformation.<p>Deequ provides a convenient way to profile your data using the <code>ConstraintSuggestionRunner</code>. Based on the analyzed data, it collects various statistics and suggests constraints using predefined rules.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-support z-constant z-scala">ConstraintSuggestionRunner</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>onData<span class="z-punctuation z-section z-group z-begin z-scala">(</span>validDf<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>useSparkSession<span class="z-punctuation z-section z-group z-begin z-scala">(</span>spark<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>overwritePreviousFiles<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-language z-scala">true</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>saveConstraintSuggestionsJsonToPath<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
		<span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/suggestions.json<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>saveColumnProfilesJsonToPath<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
		<span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/profiles.json<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>addConstraintRules<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Rules</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">DEFAULT</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre><p>In the metrics folder, <code>profiles.json</code> is created as output. It contains extracted statistics in a semi-structured format which can be useful for data quality checks creation, as well as, data monitoring.<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>columns<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>: <span class="z-meta z-sequence z-json"><span class="z-punctuation z-section z-sequence z-begin z-json">[</span>  
	<span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>column<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Vendor Name<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>dataType<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>String<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>isDataTypeInferred<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>true<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>completeness<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">1<span class="z-punctuation z-separator z-decimal z-json">.</span>0</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>approximateNumDistinctValues<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-integer z-decimal z-json">166</span>  
	<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span><span class="z-punctuation z-separator z-sequence z-json">,</span>  
	<span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>column<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Item Number<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>dataType<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Integral<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>isDataTypeInferred<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>false<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>completeness<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">1<span class="z-punctuation z-separator z-decimal z-json">.</span>0</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>approximateNumDistinctValues<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-integer z-decimal z-json">1469</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>mean<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">59981<span class="z-punctuation z-separator z-decimal z-json">.</span>83674981477</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>maximum<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">995530<span class="z-punctuation z-separator z-decimal z-json">.</span>0</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>minimum<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">567<span class="z-punctuation z-separator z-decimal z-json">.</span>0</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>sum<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">2<span class="z-punctuation z-separator z-decimal z-json">.</span>42866457E8</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>stdDev<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">104855<span class="z-punctuation z-separator z-decimal z-json">.</span>01628803412</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>approxPercentiles<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-sequence z-json"><span class="z-punctuation z-section z-sequence z-begin z-json">[</span><span class="z-punctuation z-section z-sequence z-end z-json">]</span></span>  
	<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span><span class="z-punctuation z-separator z-sequence z-json">,</span>  
	<span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>column<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Volume Sold (Liters)<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>dataType<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Fractional<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>isDataTypeInferred<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>false<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>completeness<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">0<span class="z-punctuation z-separator z-decimal z-json">.</span>8992343788589775</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>approximateNumDistinctValues<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-integer z-decimal z-json">97</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>mean<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">11<span class="z-punctuation z-separator z-decimal z-json">.</span>238700906344382</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>maximum<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">1512<span class="z-punctuation z-separator z-decimal z-json">.</span>0</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>minimum<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">0<span class="z-punctuation z-separator z-decimal z-json">.</span>05</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>sum<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">40920<span class="z-punctuation z-separator z-decimal z-json">.</span>1099999999</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>stdDev<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-float z-decimal z-json">40<span class="z-punctuation z-separator z-decimal z-json">.</span>87384345937876</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>approxPercentiles<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-sequence z-json"><span class="z-punctuation z-section z-sequence z-begin z-json">[</span><span class="z-punctuation z-section z-sequence z-end z-json">]</span></span>  
	<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span><span class="z-punctuation z-separator z-sequence z-json">,</span>
	<span class="z-invalid z-illegal z-expected-sequence-separator z-json">.</span><span class="z-invalid z-illegal z-expected-sequence-separator z-json">.</span><span class="z-invalid z-illegal z-expected-sequence-separator z-json">.</span>
</span></span></code></pre><p>The <code>suggestions.json</code> includes a list with some basic data quality rule suggestions based on the profiled metrics. Some suggestions are more useful than others. I have noticed that sometimes columns with medium cardinality are mistaken for categorical variables, suggesting value constraints. Having tight checks is valuable, but be wary of overfitting your tests.<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>constraint_suggestions<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>: <span class="z-meta z-sequence z-json"><span class="z-punctuation z-section z-sequence z-begin z-json">[</span>  
	<span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>  
		<span class="z-invalid z-illegal z-expected-mapping-key z-json">.</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">.</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">.</span>
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>column_name<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Invoice/Item Number<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>current_value<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Completeness: 1.0<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>rule_description<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>If a column is complete in the sample, we suggest a NOT NULL constraint<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>code_for_constraint<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>.isComplete(<span class="z-constant z-character z-escape z-json">\"</span>Invoice/Item Number<span class="z-constant z-character z-escape z-json">\"</span>)<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>  
	<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span><span class="z-punctuation z-separator z-sequence z-json">,</span>
	<span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>  
		<span class="z-invalid z-illegal z-expected-mapping-key z-json">.</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">.</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">.</span>
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>column_name<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Volume Sold (Liters)<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>current_value<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Minimum: 0.05<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>rule_description<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>If we see only non-negative numbers in a column, we suggest a corresponding constraint<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
		</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>code_for_constraint<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>.isNonNegative(<span class="z-constant z-character z-escape z-json">\"</span>Volume Sold (Liters)<span class="z-constant z-character z-escape z-json">\"</span>)<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>  
	<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span><span class="z-punctuation z-separator z-sequence z-json">,</span>
</span></span></code></pre><h2 id=adding-data-quality-checks><a aria-label="Anchor link for: adding-data-quality-checks" class=zola-anchor href=#adding-data-quality-checks>üîó</a>Adding Data Quality Checks</h2><p>Now we have identified expectations for our data, we will write the data quality checks to help us identify and address any issues or inconsistencies present in the dataset.<p>The checks are defined in groups with associated description and severity. Under the hood, the checks are translated to metric calculations and predicates that indicate success or failure based on the result of said metric.<p>The checks address different types of issues and may operate on both column and dataset level. See <a href=https://github.com/awslabs/deequ/blob/master/src/main/scala/com/amazon/deequ/checks/Check.scala rel=noopener target=_blank>this file</a> for an overview of all the supported checks. If you can't find the right check, a custom check can be written in Spark SQL with the <code>satisfies()</code> method.<p>Here is an example set of data quality checks that are relevant to our business case.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">checks</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
	<span class="z-support z-constant z-scala">Check</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">CheckLevel</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Error</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Sales base checks<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>hasSize<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> >= <span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Dataset should not be empty<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Invoice/Item Number<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Date<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Store Name<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Zip Code<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Vendor Name<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Item Number<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Bottles Sold<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isComplete<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Sale<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isUnique<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Invoice/Item Number<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>hasPattern<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Invoice/Item Number<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>^INV-[0-9]{11}$<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-accessor z-scala">.</span>r<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>hasPattern<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Date<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>^[0-9]{4}-[0-9]{2}-[0-9]{2}$<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-accessor z-scala">.</span>r<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>hasPattern<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Zip Code<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>^[0-9]{5}$<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-accessor z-scala">.</span>r<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isNonNegative<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>`Bottles Sold`<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isNonNegative<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>`Sale`<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>isNonNegative<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>`Volume Sold (Liters)`<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre><p>The data quality, checks can be executed using the <code>VerificationSuite</code>:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-volatile z-scala">var</span> <span class="z-variable z-other z-readwrite z-scala">verificationSuite</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">VerificationSuite</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>onData<span class="z-punctuation z-section z-group z-begin z-scala">(</span>validDf<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>useSparkSession<span class="z-punctuation z-section z-group z-begin z-scala">(</span>spark<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>overwritePreviousFiles<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-language z-scala">true</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>saveCheckResultsJsonToPath<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/checks.json<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>addChecks<span class="z-punctuation z-section z-group z-begin z-scala">(</span>checks<span class="z-punctuation z-section z-group z-end z-scala">)</span>

<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">verificationResult</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> verificationSuite<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
<span class="z-keyword z-control z-flow z-scala">if</span> <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>verificationResult<span class="z-punctuation z-accessor z-scala">.</span>status <span class="z-keyword z-operator z-comparison z-scala">==</span> <span class="z-support z-constant z-scala">CheckStatus</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Error</span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	logger<span class="z-punctuation z-accessor z-scala">.</span>error<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Data quality checks failed. Results: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">verificationResult<span class="z-punctuation z-accessor z-scala">.</span>checkResults</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	sys<span class="z-punctuation z-accessor z-scala">.</span>exit<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>Running the checks as is, will result in a failure. The generated report (e.g., <code>checks.json</code>) generally provides enough information to determine which check fail and why. By examining the report, we see the following error, implying that ~1.1% of our zip codes don't follow the five-digit format.<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json">...
<span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>  
	</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>check_status<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Error<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
	</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>check_level<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Error<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
	</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>constraint_status<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Failure<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
	</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>check<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Validity checks<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
	</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>constraint_message<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>Value: 0.9898740429735737 does not meet the constraint requirement!<span class="z-punctuation z-definition z-string z-end z-json">"</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>  
	</span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>constraint<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>PatternMatchConstraint(Zip Code, ^[0-9]{5}$)<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>  
<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>,
...
</span></code></pre><p>This is in fact correct, as the zip code column in the dataset may contain some straggling characters. This can be fixed by either reducing the check sensitivity or addressing the issues before the checks are run:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">validDf</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> schemaResult<span class="z-punctuation z-accessor z-scala">.</span>validRows  
	<span class="z-punctuation z-accessor z-scala">.</span>withColumn<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Zip Code<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">F</span><span class="z-punctuation z-accessor z-scala">.</span>regexp_extract<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">F</span><span class="z-punctuation z-accessor z-scala">.</span>col<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Zip Code<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>[0-9]{5}<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre><h2 id=collecting-data-quality-metrics><a aria-label="Anchor link for: collecting-data-quality-metrics" class=zola-anchor href=#collecting-data-quality-metrics>üîó</a>Collecting Data Quality Metrics</h2><p>Metrics provide valuable insights into the health and quality of our data. They can help us see trends, make improvements, and find anomalies in our data. Some metrics are necessary for configured checks and are computed automatically, while others may be needed for external systems such as monitoring dashboards or data catalogs and need to be specified manually.<p>These additional metrics, need to be added manually as <a href=https://github.com/awslabs/deequ/tree/master/src/main/scala/com/amazon/deequ/analyzers rel=noopener target=_blank>analyzers</a>:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-modifier z-access z-scala">private</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">numericMetrics</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">column</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">String</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Seq</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Analyzer</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">Metric</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
	<span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
		<span class="z-support z-constant z-scala">Minimum</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>column<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
		<span class="z-support z-constant z-scala">Maximum</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>column<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
		<span class="z-support z-constant z-scala">Mean</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>column<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
		<span class="z-support z-constant z-scala">StandardDeviation</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>column<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
		<span class="z-support z-constant z-scala">ApproxQuantile</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>column<span class="z-punctuation z-separator z-scala">,</span> <span class="z-constant z-numeric z-float z-decimal z-scala">0<span class="z-punctuation z-separator z-decimal z-scala">.</span>5</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-section z-group z-end z-scala">)</span>
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span>  
  
<span class="z-storage z-modifier z-access z-scala">private</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">categoricalMetrics</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">column</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">String</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Seq</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Analyzer</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">Metric</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	<span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
		<span class="z-support z-constant z-scala">CountDistinct</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>column<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
	<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>Below, we create analyzers to generically compute the distribution of numeric columns.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">analysers</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
	numericMetrics<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Bottles Sold<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	++ numericMetrics<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Sale<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	++ numericMetrics<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Volume Sold (Liters)<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	++ categoricalMetrics<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Store Name<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	++ categoricalMetrics<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Vendor Name<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	++ <span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
		<span class="z-support z-constant z-scala">Completeness</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Bottles Sold<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
	<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-group z-end z-scala">)</span></span>
</span></code></pre><p>Similar to quality checks, the metrics are computed using the <code>VerificationSuite.run()</code> method:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-volatile z-scala">var</span> <span class="z-variable z-other z-readwrite z-scala">verificationSuite</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">VerificationSuite</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span> 
	<span class="z-punctuation z-accessor z-scala">.</span>saveSuccessMetricsJsonToPath<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/metrics.json<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span>addRequiredAnalyzers<span class="z-punctuation z-section z-group z-begin z-scala">(</span>analysers<span class="z-punctuation z-section z-group z-end z-scala">)</span>
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span>
</span></code></pre><p>The collected metrics are written to <code>metrics.json</code> file, which can be loaded by external tools. Alternatively, Deequ defines a concept of <a href=https://github.com/awslabs/deequ/blob/master/src/main/scala/com/amazon/deequ/examples/metrics_repository_example.md rel=noopener target=_blank>metric repositories</a> as an interface for saving the metrics to other systems in a generic manner. You can write your own repository to store the metrics in, for example, Prometheus or AWS Cloud Watch.<p>Another useful feature is <a href=https://github.com/awslabs/deequ/blob/master/src/main/scala/com/amazon/deequ/examples/KLLExample.scala rel=noopener target=_blank>KLL Sketches</a> which supports, approximate, but highly accurate metric calculation on data by sampling.<h3 id=incremental-computation-of-metrics><a aria-label="Anchor link for: incremental-computation-of-metrics" class=zola-anchor href=#incremental-computation-of-metrics>üîó</a>Incremental Computation of Metrics</h3><p>In the realm of ETL workloads, it is rare for data engineers to reprocess the entire dataset. Typically, pipelines are designed to be incremental, processing only new data. However, if your data quality checks rely on metrics computed over the entire dataset, this can lead to a continuous increase in load on your Spark cluster.<figure class=image-captions-figure><img alt="Anomaly Detection on Row Count quality metric in Soda Cloud" height=250 src=https://egordmitriev.dev/processed_images/deequ_aggregated_states.5be2b005e66b8feb.png width=500><figcaption class=image-captions-caption><p>Instead of repeatedly running the batch computation on growing input data D, incremental computation is supported hat only needs (t) to consume the latest dataset delta ‚àÜD and a state S of the computation. Source: <a href=https://www.vldb.org/pvldb/vol11/p1781-schelter.pdf rel=noopener target=_blank>technical paper</a>.</p></figcaption></figure><p>To address this challenge, Deequ introduces a concept of ‚ÄúAlgebraic states.‚Äù These states store calculated metrics and the corresponding data, enabling their aggregation across multiple pipeline runs. Consequently, only the incremental data needs to be processed, significantly reducing the computational burden.<p>We demonstrate this by adding complete dataset checks within our incremental ETL script. The first step is to record incremental metrics in a temporary in-memory state provider:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">incrementalStateProvider</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">InMemoryStateProvider</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">verificationResult</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">VerificationSuite</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span>
	<span class="z-punctuation z-accessor z-scala">.</span>saveStatesWith<span class="z-punctuation z-section z-group z-begin z-scala">(</span>incrementalStateProvider<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span>
</span></code></pre><p>To load the aggregated state from a persistent provider, a persistent state provider is needed. Additionally, we check if the state already exists to determine whether it should be included in the aggregation, specifically necessary for first pipeline run:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Initialize state for incremental metric computation  </span>
<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">completeStatePath</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/state_repository/<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span>
<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">completeStateProvider</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HdfsStateProvider</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>spark<span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">completeStatePath</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/state.json<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> allowOverwrite <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-language z-scala">true</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

<span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Determine if the complete state already exists</span>
<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">fs</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">FileSystem</span><span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-begin z-scala">(</span>spark<span class="z-punctuation z-accessor z-scala">.</span>sparkContext<span class="z-punctuation z-accessor z-scala">.</span>hadoopConfiguration<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">aggregateStates</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-control z-exception z-scala">try</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	fs<span class="z-punctuation z-accessor z-scala">.</span>listFiles<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-keyword z-other z-scala">new</span> <span class="z-support z-class z-scala">Path</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>completeStatePath<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-constant z-language z-scala">false</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>hasNext  
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span> <span class="z-keyword z-control z-exception z-scala">catch</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	<span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">FileNotFoundException</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=></span><span class="z-meta z-block z-case z-first z-scala"> <span class="z-constant z-language z-scala">false</span>  
</span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>Now, once again, we can run <code>VerificationSuite</code>, but this time we use the providers to load state data. Consequently, the checks and metrics are computed and merged over the aggregated state, which, in this case, represents the complete dataset:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Merge incremental metrics with complete metrics, and run data quality checks  </span>
<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">completeChecks</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
	<span class="z-support z-constant z-scala">Check</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">CheckLevel</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Error</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Sales complete checks<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
		<span class="z-punctuation z-accessor z-scala">.</span>hasSize<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> >= <span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Dataset should not be empty<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-group z-end z-scala">)</span>

logger<span class="z-punctuation z-accessor z-scala">.</span>info<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Running complete dataset checks<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">completeVerificationResult</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">VerificationSuite</span><span class="z-punctuation z-accessor z-scala">.</span>runOnAggregatedStates<span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
	validDf<span class="z-punctuation z-accessor z-scala">.</span>schema<span class="z-punctuation z-separator z-scala">,</span>  
	completeChecks<span class="z-punctuation z-separator z-scala">,</span>  
	<span class="z-keyword z-control z-flow z-scala">if</span> <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>aggregateStates<span class="z-punctuation z-section z-group z-end z-scala">)</span></span> <span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>completeStateProvider<span class="z-punctuation z-separator z-scala">,</span> incrementalStateProvider<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-keyword z-control z-flow z-scala">else</span> <span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>incrementalStateProvider<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>  
	saveStatesWith <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>completeStateProvider<span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-group z-end z-scala">)</span>
<span class="z-keyword z-control z-flow z-scala">if</span> <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>completeVerificationResult<span class="z-punctuation z-accessor z-scala">.</span>status <span class="z-keyword z-operator z-comparison z-scala">==</span> <span class="z-support z-constant z-scala">CheckStatus</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Error</span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>  
	logger<span class="z-punctuation z-accessor z-scala">.</span>error<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Complete data quality checks failed. Results: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">completeVerificationResult<span class="z-punctuation z-accessor z-scala">.</span>checkResults</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	sys<span class="z-punctuation z-accessor z-scala">.</span>exit<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
<span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>This feature provides granular control over metric computation and therefore supports a multitude of implementations. For instance, you may choose to save the state <em>only</em> when the entire pipeline succeeds, or you may want to perform anomaly detection on the complete dataset.<h2 id=gracefully-handling-data-changes><a aria-label="Anchor link for: gracefully-handling-data-changes" class=zola-anchor href=#gracefully-handling-data-changes>üîó</a>Gracefully Handling Data Changes</h2><p>When working with external data sources, it's common for changes to occur, which can lead to failed checks if not properly handled. To ensure backward compatibility and smooth data processing, there are two options you can consider:<p><strong>Filterable Constraint Checks</strong>: these are conditional checks that are only executed if a specific condition is satisfied, such as when the input data is from an older dataset version. This allows you to accommodate changes in the data structure while still maintaining compatibility.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">checks</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Seq</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>  
	<span class="z-support z-constant z-scala">Check</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">CheckLevel</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Error</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Sales base checks<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
		<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-separator z-scala">,</span>
	<span class="z-support z-constant z-scala">Check</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">CheckLevel</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Error</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Legacy checks<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
		<span class="z-punctuation z-accessor z-scala">.</span>hasPattern<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Date<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>^[0-9]{2}/[0-9]{2}/[0-9]{4}$<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-accessor z-scala">.</span>r<span class="z-punctuation z-section z-group z-end z-scala">)</span>
		<span class="z-punctuation z-accessor z-scala">.</span>where<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>year < 2022<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre><p><strong>Splitting by Data Version</strong>: Unfortunately, conditional checks are not applicable for schema checks. Cases such as column addition or deletion need to be addressed separately. In such cases, it's recommended to keep your data versions close at hand and use them as a discriminator to run various checks for different versions. Splitting by version enables you to have granular control over the checks while still keeping the code reusability.<h2 id=anomaly-detection><a aria-label="Anchor link for: anomaly-detection" class=zola-anchor href=#anomaly-detection>üîó</a>Anomaly Detection</h2><p>Anomaly detection is a crucial aspect of data quality testing that helps identify unexpected or unusual patterns in the data based on historical observations. Deequ provides several anomaly detection <a href=https://github.com/awslabs/deequ/tree/master/src/main/scala/com/amazon/deequ/anomalydetection rel=noopener target=_blank>strategies</a> that can be applied to different aspects of the data.<p>Before applying anomaly detection, it is important to store the metrics in a persistent repository. This ensures that historical metrics are available for comparison and trend analysis. In the code snippet below, we use a <code>FileSystemMetricsRepository</code> to store the metrics in a file system location:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">metricsRepository</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">MetricsRepository</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      <span class="z-support z-constant z-scala">FileSystemMetricsRepository</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>spark<span class="z-punctuation z-separator z-scala">,</span> <span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">args<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>metrics_path<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span></span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>/metrics_repository.json<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

<span class="z-storage z-type z-volatile z-scala">var</span> <span class="z-variable z-other z-readwrite z-scala">verificationSuite</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">VerificationSuite</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span> 
	<span class="z-punctuation z-accessor z-scala">.</span>useRepository<span class="z-punctuation z-section z-group z-begin z-scala">(</span>metricsRepository<span class="z-punctuation z-section z-group z-end z-scala">)</span>
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span>
</span></code></pre><p>Once at least one data point is collected and stored in the metrics repository, we can apply anomaly detection strategies.<p>One useful application of anomaly detection is keeping the data volume in check. If your dataset is expected to grow at a predictable pace or remain stationary, you can add anomaly detection on the row count. This helps identify unexpected changes introduced by external systems or transformation scripts.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-volatile z-scala">var</span> <span class="z-variable z-other z-readwrite z-scala">verificationSuite</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">VerificationSuite</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>  
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span> 
	<span class="z-punctuation z-accessor z-scala">.</span>addAnomalyCheck<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
        <span class="z-support z-constant z-scala">RelativeRateOfChangeStrategy</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>maxRateIncrease <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-float z-decimal z-scala">2<span class="z-punctuation z-separator z-decimal z-scala">.</span>0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>
        <span class="z-support z-constant z-scala">Size</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>
        <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">AnomalyCheckConfig</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>
	        <span class="z-support z-constant z-scala">CheckLevel</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-constant z-scala">Warning</span><span class="z-punctuation z-separator z-scala">,</span>
	        <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Dataset doubling or halving is anomalous<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span>
        <span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-group z-end z-scala">)</span>
	<span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span>
</span></code></pre><p>Similarly, anomaly detection can be applied to specific columns where you have knowledge about the expected distribution or behavior of the data.<p>When an anomaly is found, you have the option to handle it based on the severity of the issue. If the anomaly is critical, you can stop the pipeline to avoid propagating the issue further, or if the anomaly is not severe, you can emit a warning to your monitoring systems for further investigation.<p>By incorporating anomaly detection into your data quality checks, you can proactively identify and address unexpected or unusual patterns in your data, ensuring the overall quality and reliability of your data pipelines.<h2 id=conclusion><a aria-label="Anchor link for: conclusion" class=zola-anchor href=#conclusion>üîó</a>Conclusion</h2><p>In this blog, we have set up a data quality checking solution for our Spark ETL pipeline by incorporating the open-source library Deequ. We have covered how one can use Deequ for schema checking, data profiling, quality constraints testing, quality metric collection, and anomaly detection.<p>If you prefer writing scripts in Python (i.e., PySpark), then <a href=https://github.com/awslabs/python-deequ rel=noopener target=_blank>PyDeequ</a> may be of help, which is a Python library for Deequ. At the time of writing this blog, this library is a bit behind and doesn't yet support some features we have discussed.<p>Check out the previous blog ‚Äú<a href=https://www.luminis.eu/blog/introduction-to-data-quality/ rel=noopener target=_blank>Introduction to Data Quality</a>‚Äù if you haven't yet, which may give you ideas on how to implement your data quality checks.<h3 id=more-resources><a aria-label="Anchor link for: more-resources" class=zola-anchor href=#more-resources>üîó</a>More Resources</h3><ul><li><a href=https://aws.amazon.com/blogs/big-data/test-data-quality-at-scale-with-deequ/ rel=noopener target=_blank>Test data quality at scale with Deequ | AWS Big Data Blog</a><li><a href=https://aws.amazon.com/blogs/big-data/building-a-serverless-data-quality-and-analysis-framework-with-deequ-and-aws-glue/ rel=noopener target=_blank>Building a serverless data quality and analysis framework with Deequ and AWS Glue | AWS Big Data Blog</a><li><a href=https://www.vldb.org/pvldb/vol11/p1781-schelter.pdf rel=noopener target=_blank>Automating Large-Scale Data Quality Verification - Original Deequ Technical Paper</a><li>AWS is currently building an integrated solution for data quality checking in AWS Glue. It still lacks many features of Deequ, but it is worth keeping an eye on this one as it is in active development. <ul><li><a href=https://aws.amazon.com/glue/features/data-quality/ rel=noopener target=_blank>Data Quality ‚Äì AWS Glue Data Quality‚Äì Amazon Web Services</a></ul><li>See more examples on <a href=https://github.com/awslabs/deequ rel=noopener target=_blank>Deequ GitHub page</a></ul></section></article></main></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://egordmitriev.dev/atom.xml target=_blank> <img alt=atom feed src=https://egordmitriev.dev/social_icons/rss.svg title=atom> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://github.com/egordm/ target=_blank> <img alt=github src=https://egordmitriev.dev/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://www.linkedin.com/in/egor-dmitriev/ target=_blank> <img alt=linkedin src=https://egordmitriev.dev/social_icons/linkedin.svg title=linkedin> </a></ul></nav><div class=credits><small>Powered by <a href=https://www.getzola.org target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi target=_blank>tabi</a></small></div></section></footer>